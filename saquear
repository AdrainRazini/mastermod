-- üîß Servi√ßos
local Players = game:GetService("Players")
local PathfindingService = game:GetService("PathfindingService")
local RunService = game:GetService("RunService")

-- üîÑ Vari√°veis principais
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

-- üß† Estados e dados
local savedPoints = {}
local farmando = false
local index = 1
local modoAtual = "Teleport"

-- GUI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "FarmSystemGui"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 340, 0, 560)
frame.Position = UDim2.new(0, 100, 0, 100)
frame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
frame.Draggable = true
frame.Active = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

local statusBall = Instance.new("Frame", frame)
statusBall.Size = UDim2.new(0, 16, 0, 16)
statusBall.Position = UDim2.new(0, -8, 0, -8)
statusBall.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
statusBall.BorderSizePixel = 0
Instance.new("UICorner", statusBall).CornerRadius = UDim.new(1, 0)

local function atualizarStatus(cor)
	statusBall.BackgroundColor3 = cor
end

-- Inputs e GUI (mantido como antes...)

-- Completa fun√ß√£o bot√£o
local function criarBotaoPonto(data)
	local btn = Instance.new("TextButton", scroll)
	btn.Size = UDim2.new(1, 0, 0, 30)
	btn.Text = "üìç " .. data.nome
	btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 13
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)

	btn.MouseButton1Click:Connect(function()
		moverPara(data.pos)
	end)
end

salvarBtn.MouseButton1Click:Connect(function()
	local nome = nameBox.Text ~= "" and nameBox.Text or "Sem Nome"
	local coords = coordBox.Text
	local x, y, z = coords:match("([^,]+),([^,]+),([^,]+)")
	if x and y and z then
		local pos = Vector3.new(tonumber(x), tonumber(y), tonumber(z))
		local part = criarMarcador(nome, pos)
		table.insert(savedPoints, {nome = nome, pos = pos, part = part})
		criarBotaoPonto({nome = nome, pos = pos})
		nameBox.Text, coordBox.Text = "", ""
	end
end)

usarLocalBtn.MouseButton1Click:Connect(function()
	local pos = hrp.Position
	coordBox.Text = string.format("%.1f, %.1f, %.1f", pos.X, pos.Y, pos.Z)
end)

-- Modos
local modos = {"Teleport", "Andar", "IA"}
for i, modo in ipairs(modos) do
	local btn = Instance.new("TextButton", frame)
	btn.Size = UDim2.new(0.28, 0, 0, 25)
	btn.Position = UDim2.new(0.05 + (i-1)*0.31, 0, 0, 470)
	btn.Text = modo
	btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 12
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)
	btn.MouseButton1Click:Connect(function()
		modoAtual = modo
		for _, child in pairs(frame:GetChildren()) do
			if child:IsA("TextButton") and table.find(modos, child.Text) then
				child.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
			end
		end
		btn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
	end)
end

-- Movimento
local function moverPara(pos)
	if modoAtual == "Teleport" then
		hrp.CFrame = CFrame.new(pos)
	elseif modoAtual == "Andar" then
		humanoid:MoveTo(pos)
	elseif modoAtual == "IA" then
		local path = PathfindingService:CreatePath()
		path:ComputeAsync(hrp.Position, pos)
		if path.Status == Enum.PathStatus.Success then
			for _, waypoint in pairs(path:GetWaypoints()) do
				humanoid:MoveTo(waypoint.Position)
				humanoid.MoveToFinished:Wait()
			end
		end
	end
end

-- Buscar NPC
local function getNpcMaisProximo(minDist, maxDist)
	local pastaNpcs = workspace:FindFirstChild("EnemyFolder")
	if not pastaNpcs then return end
	local menor = math.huge
	local alvo = nil
	for _, npc in ipairs(pastaNpcs:GetChildren()) do
		local hrpNpc = npc:FindFirstChild("HumanoidRootPart")
		local hum = npc:FindFirstChild("Humanoid")
		if npc:IsA("Model") and hrpNpc and hum and hum.Health > 0 then
			local dist = (hrp.Position - hrpNpc.Position).Magnitude
			if dist >= minDist and dist <= maxDist and dist < menor then
				menor = dist
				alvo = npc
			end
		end
	end
	return alvo
end

-- Loop do farm
local function iniciarFarm()
	farmando = true
	index = 1
	while farmando and #savedPoints > 0 do
		local ponto = savedPoints[index]
		if not ponto then break end
		atualizarStatus(Color3.fromRGB(255, 255, 0))
		moverPara(ponto.pos)
		task.wait(tonumber(delayBox.Text) or 2)
		local min = tonumber(minDistBox.Text) or 10
		local max = tonumber(maxDistBox.Text) or 50

		local tempoSemNpc = 0
		while farmando do
			local alvo = getNpcMaisProximo(min, max)
			if alvo then
				atualizarStatus(Color3.fromRGB(0, 255, 0))
				humanoid:MoveTo(alvo.HumanoidRootPart.Position)
				humanoid.MoveToFinished:Wait(5)
				tempoSemNpc = 0
			else
				atualizarStatus(Color3.fromRGB(255, 255, 0))
				tempoSemNpc += 1
				if tempoSemNpc >= 10 then break end
				task.wait(1)
			end
		end
		index += 1
		if index > #savedPoints then index = 1 end
	end
	atualizarStatus(Color3.fromRGB(255, 0, 0))
end

-- Bot√µes iniciar/parar
local iniciarBtn = Instance.new("TextButton", frame)
iniciarBtn.Text = "‚ñ∂ Iniciar Farm"
iniciarBtn.Size = UDim2.new(0.42, 0, 0, 30)
iniciarBtn.Position = UDim2.new(0.05, 0, 0, 510)
iniciarBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
iniciarBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
iniciarBtn.Font = Enum.Font.GothamBold
iniciarBtn.TextSize = 14
Instance.new("UICorner", iniciarBtn).CornerRadius = UDim.new(0, 6)

local pararBtn = Instance.new("TextButton", frame)
pararBtn.Text = "‚èπ Parar"
pararBtn.Size = UDim2.new(0.42, 0, 0, 30)
pararBtn.Position = UDim2.new(0.53, 0, 0, 510)
pararBtn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
pararBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
pararBtn.Font = Enum.Font.GothamBold
pararBtn.TextSize = 14
Instance.new("UICorner", pararBtn).CornerRadius = UDim.new(0, 6)

iniciarBtn.MouseButton1Click:Connect(function()
	if not farmando then
		iniciarFarm()
	end
end)

pararBtn.MouseButton1Click:Connect(function()
	farmando = false
end)
